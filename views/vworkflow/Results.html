{% import (
  "fmt"
  "strings"

  "github.com/kyleu/loadtoad/app"
  "github.com/kyleu/loadtoad/app/controller/cutil"
  "github.com/kyleu/loadtoad/app/loadtoad"
  "github.com/kyleu/loadtoad/app/util"
  "github.com/kyleu/loadtoad/views/components"
  "github.com/kyleu/loadtoad/views/layout"
  "github.com/kyleu/loadtoad/views/vhar"
) %}

{% code type Results struct {
  layout.Basic
  Workflow *loadtoad.Workflow
  Results loadtoad.WorkflowResults
} %}

{% func (p *Results) Body(as *app.State, ps *cutil.PageState) %}
  <div class="card">
    <div class="right"><a href="#modal-workflow"><button type="button">JSON</button></a></div>
    {%= components.JSONModal("workflow", "Workflow", p.Workflow, 3) %}
    <h3>{%= components.SVGRefIcon(`file-code`, ps) %} {%s p.Workflow.Title() %} Results</h3>
    <div class="mts"><em>{%s util.StringPlural(len(p.Results), "result") %} in {%s util.MicrosToMillis(p.Results.Duration()) %}</em></div>
  </div>
  {%- for rIdx, r := range p.Results -%}
  {%= RenderResult(rIdx, r, ps) %}
  {%- endfor -%}
{% endfunc %}

{% func renderBool(b bool, s string, ps *cutil.PageState) %}
  {%- if b -%}
    <span class="success">{%s s %}</span>
  {%- else -%}
    <span class="error">{%s s %}</span>
  {%- endif -%}
{% endfunc %}

{% func RenderResult(rIdx int, r *loadtoad.WorkflowResult, ps *cutil.PageState) %}
  <div class="card">
    <div class="right"><a href="#modal-result-{%d rIdx %}"><button type="button">JSON</button></a></div>
    {%= components.JSONModal(fmt.Sprintf("result-%d", rIdx), r.Title(), r, 3) %}
    <h3>{%= components.SVGRefIcon(`file`, ps) %}{%s r.Title() %}</h3>
    <div class="clear"></div>
    <div class="mts">
      {%= RenderResultTable(rIdx, r, ps) %}
    </div>
  </div>
{% endfunc %}

{% func RenderResultTable(rIdx int, r *loadtoad.WorkflowResult, ps *cutil.PageState) %}
  <table class="min-200">
    <thead>
      <tr>
        <th class="shrink"></th>
        <th class="shrink">Old</th>
        <th class="shrink">New</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>{%= renderBool(r.Response.Status == r.Entry.Response.Status, "Status", ps) %}</th>
        <td>{%d r.Entry.Response.Status %}</td>
        <td>{%d r.Response.Status %}</td>
      </tr>
      <tr>
        <th title="duration must be within ({%f float64(r.Entry.Time) %} * 1.3) + 10), which equals {%s util.MicrosToMillis(int(r.Entry.Time * 1000 * 1.3) + 10000) %}">
          {%= renderBool(r.Entry.Time == 0 || r.Timing.Total < int(r.Entry.Time * 1000 * 1.3) + 10000, "Duration", ps) %}
        </th>
        <td>{%s util.MicrosToMillis(int(r.Entry.Time * 1000)) %}</td>
        <td>
          {%s util.MicrosToMillis(r.Timing.Total) %}
          <em>{%s strings.Join(r.Timing.Strings(), ", ") %}</em>
        </td>
      </tr>
    </tbody>
  </table>
{% endfunc %}

{% func RenderResultModal(key string, r *loadtoad.WorkflowResult, ps *cutil.PageState) %}
  <h4>Request</h4>
  {%= vhar.RenderRequest(key, r.Entry.Request, ps) %}
  <hr />
  <h4>Response</h4>
  {%= vhar.RenderResponse(key, r.Response, ps) %}
{% endfunc %}
